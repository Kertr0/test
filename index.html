<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Particles: Final</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #00ff88;
            --glass: rgba(10, 10, 10, 0.7);
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }

        /* –≠–ö–†–ê–ù –°–¢–ê–†–¢–ê (–ß—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ) */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: var(--primary); color: #000;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 20px var(--primary); transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); }
        
        /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #canvas-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; }
        
        .ui-panel {
            position: absolute; top: 20px; right: 20px; width: 240px;
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            z-index: 10; display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ —Å—Ç–∞—Ä—Ç–∞ */
        }
        
        .shape-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        
        button.shape-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            color: #ccc; padding: 8px; border-radius: 5px; cursor: pointer;
        }
        button.shape-btn:hover { background: rgba(255,255,255,0.2); }
        button.shape-btn.active { background: var(--primary); color: #000; font-weight: bold; }

        #status-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 8px 20px; border-radius: 30px;
            font-size: 12px; border: 1px solid rgba(255,255,255,0.2);
            z-index: 10; display: none;
        }
        
        #webcam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 120px; height: 90px;
            background: #000; border: 1px solid var(--primary); z-index: 10;
            transform: scaleX(-1); opacity: 0.5; display: none;
        }
    </style>

    <!-- –¢–µ –∂–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —á—Ç–æ –∏ –≤ —Ä–∞–±–æ—á–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
    <div id="start-screen">
        <h1 style="margin-bottom: 20px;">AI Particles</h1>
        <button id="start-btn" onclick="initApp()">–ó–ê–ü–£–°–¢–ò–¢–¨ –°–ò–°–¢–ï–ú–£</button>
        <p style="color: #888; margin-top: 15px; font-size: 12px;">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</p>
    </div>

    <div id="canvas-container"></div>
    <video id="webcam-preview" playsinline muted></video>
    <div id="status-bar">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ü–æ–∫–∞–∂–∏—Ç–µ —Ä—É–∫—É.</div>

    <div class="ui-panel" id="ui-panel">
        <h3 style="margin:0 0 10px 0; font-size:14px; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">–£–ü–†–ê–í–õ–ï–ù–ò–ï</h3>
        
        <div class="shape-grid">
            <button class="shape-btn active" onclick="setShape('sphere')">–°—Ñ–µ—Ä–∞</button>
            <button class="shape-btn" onclick="setShape('heart')">–°–µ—Ä–¥—Ü–µ</button>
            <button class="shape-btn" onclick="setShape('saturn')">–°–∞—Ç—É—Ä–Ω</button>
            <button class="shape-btn" onclick="setShape('dna')">–î–ù–ö</button>
        </div>
        
        <label style="font-size:11px; color:#888;">–¶–≤–µ—Ç —á–∞—Å—Ç–∏—Ü:</label>
        <input type="color" id="colorPicker" value="#00ff88" style="width:100%; height:30px; border:none; background:none; cursor:pointer;">
        
        <div style="margin-top:15px; font-size:10px; color:#666; line-height:1.5;">
            ü§è –°–≤–µ–¥–∏ –ø–∞–ª—å—Ü—ã: <b>–ó—É–º</b><br>
            üïπÔ∏è –î–≤–∏–≥–∞–π —Ä—É–∫–æ–π: <b>–í—Ä–∞—â–µ–Ω–∏–µ</b><br>
            üé§ –ó–≤—É–∫: <b>–ü—É–ª—å—Å–∞—Ü–∏—è</b>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let scene, camera, renderer, particles;
        let audioCtx, analyser, dataArray, isAudioActive = false;
        
        const STATE = {
            scale: 1, rotX: 0, rotY: 0, tilt: 0, 
            beat: 0, color: new THREE.Color(0x00ff88)
        };
        
        const TARGET = {
            scale: 1, x: 0, y: 0, tilt: 0, detected: false
        };

        const CONFIG = { count: 18000, size: 0.08 };

        // --- 1. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        async function initApp() {
            const startScreen = document.getElementById('start-screen');
            startScreen.innerHTML = "<h3>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...</h3>";
            
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
            initThree();
            
            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ê—É–¥–∏–æ (–ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª)
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 128;
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioActive = true;
            } catch(e) {
                console.warn("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:", e);
            }

            // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe
            initMediaPipe().then(() => {
                startScreen.style.display = 'none';
                document.getElementById('ui-panel').style.display = 'block';
                document.getElementById('webcam-preview').style.display = 'block';
                document.getElementById('status-bar').style.display = 'block';
            });
        }

        // --- 2. THREE.JS ---
        let targetPositions = new Float32Array(CONFIG.count * 3);

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 8;
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // –¢–µ–∫—Å—Ç—É—Ä–∞ —Å–≤–µ—á–µ–Ω–∏—è
            const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
            const ctx = cvs.getContext('2d');
            const grd = ctx.createRadialGradient(16,16,0,16,16,16);
            grd.addColorStop(0,'white'); grd.addColorStop(1,'transparent');
            ctx.fillStyle = grd; ctx.fillRect(0,0,32,32);
            const tex = new THREE.Texture(cvs); tex.needsUpdate = true;
            
            // –ß–∞—Å—Ç–∏—Ü—ã
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.count * 3);
            for(let i=0; i<CONFIG.count*3; i++) pos[i] = (Math.random()-0.5)*20;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            
            const mat = new THREE.PointsMaterial({
                size: CONFIG.size, map: tex, transparent: true, opacity: 0.8,
                blending: THREE.AdditiveBlending, depthWrite: false, color: STATE.color
            });
            
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π —Ñ–æ—Ä–º—ã
            setShape('sphere');
            
            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
            animate();
        }

        // --- 3. –õ–û–ì–ò–ö–ê –ê–ù–ò–ú–ê–¶–ò–ò ---
        function lerp(s, e, a) { return (1-a)*s + a*e; }

        function animate() {
            requestAnimationFrame(animate);

            // A. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ó–≤—É–∫–∞
            if(isAudioActive && analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 5 —á–∞—Å—Ç–æ—Ç (–±–∞—Å—ã)
                for(let i=0; i<5; i++) sum += dataArray[i];
                const vol = (sum / 5) / 255; // 0.0 ... 1.0
                STATE.beat = lerp(STATE.beat, vol, 0.2);
                
                // –í—Å–ø—ã—à–∫–∞ —Ü–≤–µ—Ç–∞
                if(STATE.beat > 0.2) {
                    const h = STATE.color.getHSL({});
                    particles.material.color.setHSL(h.h, h.s, Math.min(1, 0.5 + STATE.beat));
                } else {
                    particles.material.color.lerp(STATE.color, 0.1);
                }
            }

            // B. –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫ –¶–µ–ª—è–º (–ü–ª–∞–≤–Ω–æ—Å—Ç—å)
            if(TARGET.detected) {
                // –ó—É–º: —â–∏–ø–æ–∫
                STATE.scale = lerp(STATE.scale, TARGET.scale, 0.08);
                
                // –í—Ä–∞—â–µ–Ω–∏–µ: –¥–∂–æ–π—Å—Ç–∏–∫
                const vx = (Math.abs(TARGET.x) > 0.1) ? TARGET.x * 0.05 : 0;
                const vy = (Math.abs(TARGET.y) > 0.1) ? TARGET.y * 0.05 : 0;
                STATE.rotY = lerp(STATE.rotY, vx, 0.08);
                STATE.rotX = lerp(STATE.rotX, vy, 0.08);
                
                // –ù–∞–∫–ª–æ–Ω
                STATE.tilt = lerp(STATE.tilt, -TARGET.tilt, 0.08);
            } else {
                // Idle (—Ä–µ–∂–∏–º –ø—Ä–æ—Å—Ç–æ—è)
                STATE.scale = lerp(STATE.scale, 1, 0.05);
                STATE.rotY = lerp(STATE.rotY, 0.002, 0.05); // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
                STATE.rotX = lerp(STATE.rotX, 0, 0.05);
                STATE.tilt = lerp(STATE.tilt, 0, 0.05);
            }

            // C. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
            // –ú–∞—Å—à—Ç–∞–± = –†—É–∫–∞ + –ë–∏—Ç
            const finalScale = STATE.scale + (STATE.beat * 0.4);
            particles.scale.set(finalScale, finalScale, finalScale);
            
            particles.rotation.y += STATE.rotY;
            particles.rotation.x += STATE.rotX;
            particles.rotation.z = STATE.tilt;
            
            // D. –ú–æ—Ä—Ñ–∏–Ω–≥ —á–∞—Å—Ç–∏—Ü
            const p = particles.geometry.attributes.position.array;
            for(let i=0; i<CONFIG.count*3; i++) {
                p[i] += (targetPositions[i] - p[i]) * 0.08;
            }
            particles.geometry.attributes.position.needsUpdate = true;
            
            renderer.render(scene, camera);
        }

        // --- 4. MEDIAPIPE ---
        async function initMediaPipe() {
            const videoElement = document.getElementById('webcam-preview');
            
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    TARGET.detected = true;
                    document.getElementById('status-bar').innerText = "–†—É–∫–∞ –∑–∞—Ö–≤–∞—á–µ–Ω–∞";
                    document.getElementById('status-bar').style.borderColor = "#00ff88";
                    
                    const lm = results.multiHandLandmarks[0];
                    
                    // 1. –ó—É–º (–©–∏–ø–æ–∫)
                    const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    // dist: 0.02 (–±–ª–∏–∑–∫–æ) ... 0.2 (–¥–∞–ª–µ–∫–æ)
                    // scale: 2.5 ... 0.5
                    TARGET.scale = Math.max(0.5, Math.min(3.0 - dist * 10, 3.0));
                    
                    // 2. –î–∂–æ–π—Å—Ç–∏–∫ (–¶–µ–Ω—Ç—Ä –ª–∞–¥–æ–Ω–∏)
                    // X mirrored
                    TARGET.x = ((lm[0].x + lm[9].x)/2 - 0.5) * 2;
                    TARGET.y = ((lm[0].y + lm[9].y)/2 - 0.5) * 2;
                    
                    // 3. –ù–∞–∫–ª–æ–Ω
                    TARGET.tilt = Math.atan2(lm[9].y - lm[0].y, lm[9].x - lm[0].x) + Math.PI/2;
                    
                } else {
                    TARGET.detected = false;
                    document.getElementById('status-bar').innerText = "–ü–æ–∫–∞–∂–∏—Ç–µ —Ä—É–∫—É";
                    document.getElementById('status-bar').style.borderColor = "#fff";
                }
            });

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 320, height: 240
            });
            
            return cameraUtils.start();
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        window.setShape = function(s) {
            // –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ñ–æ—Ä–º
            for(let i=0; i<CONFIG.count; i++) {
                let x,y,z, r1=Math.random(), r2=Math.random();
                if(s==='sphere'){
                    const t=r1*6.28, p=Math.acos(2*r2-1), r=3.5;
                    x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p);
                } else if(s==='heart'){
                    const t=r1*6.28, p=r2*3.14;
                    x=16*Math.pow(Math.sin(t),3); 
                    y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
                    z=5*Math.cos(p)*Math.sin(t);
                    x*=0.18; y*=0.18; z*=0.18;
                } else if(s==='saturn') {
                    const ang=r1*6.28, dist=i<CONFIG.count*0.7 ? 2.8 : 4+r2*3;
                    if(i<CONFIG.count*0.7) {
                        const ph=Math.acos(2*r2-1);
                        x=dist*Math.sin(ph)*Math.cos(ang); y=dist*Math.sin(ph)*Math.sin(ang); z=dist*Math.cos(ph);
                    } else { x=Math.cos(ang)*dist; y=(r1-0.5)*0.3; z=Math.sin(ang)*dist; }
                } else { // DNA
                     const ang = (r1 * 3 * 6.28) + (i%2 * 3.14);
                     x=Math.cos(ang)*2 + (r2-0.5); y=(r1-0.5)*10; z=Math.sin(ang)*2 + (r2-0.5);
                }
                targetPositions[i*3]=x; targetPositions[i*3+1]=y; targetPositions[i*3+2]=z;
            }
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
        };

        document.getElementById('colorPicker').addEventListener('input', (e) => {
            STATE.color.set(e.target.value);
        });

        window.addEventListener('resize', () => {
            if(camera) {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>