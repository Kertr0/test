<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Audio Visualizer v3</title>
    <style>
        :root {
            --primary: #00ff88;
            --bg: #000000;
            --glass: rgba(20, 20, 20, 0.7);
            --border: rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
        }

        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }

        .ui-panel {
            position: absolute; top: 20px; right: 20px; width: 260px;
            padding: 20px; background: var(--glass);
            backdrop-filter: blur(12px); border-radius: 16px;
            border: 1px solid var(--border); z-index: 10;
        }

        h2 { margin: 0 0 15px 0; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .shape-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }

        button {
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);
            color: #ccc; padding: 8px; border-radius: 6px; cursor: pointer;
            font-size: 11px; text-transform: uppercase; width: 100%;
        }
        button:hover { background: rgba(255, 255, 255, 0.15); }
        button.active { background: var(--primary); color: #000; font-weight: bold; }

        #mic-btn { margin-bottom: 15px; border-color: #ff3333; color: #ff3333; }
        #mic-btn.mic-active { border-color: var(--primary); color: var(--primary); animation: pulse 2s infinite; }

        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(0,255,136,0.4);} 70% {box-shadow: 0 0 0 10px rgba(0,255,136,0);} 100% {box-shadow: 0 0 0 0 rgba(0,255,136,0);} }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; font-size: 16px; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 10px; border: 1px solid var(--primary); text-align: center;
        }
        
        #webcam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 120px; height: 90px;
            background: #000; border-radius: 8px; opacity: 0.5; z-index: 10; transform: scaleX(-1);
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...<br><small>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</small></div>
    <div id="canvas-container"></div>
    <video id="webcam-preview" playsinline muted></video>

    <div class="ui-panel">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
        <button id="mic-btn" onclick="startAudio()">üé§ –í–∫–ª—é—á–∏—Ç—å –†–µ–∞–∫—Ü–∏—é –Ω–∞ –ó–≤—É–∫</button>
        
        <div class="shape-grid">
            <button onclick="setShape('sphere')" class="active">–°—Ñ–µ—Ä–∞</button>
            <button onclick="setShape('heart')">–°–µ—Ä–¥—Ü–µ</button>
            <button onclick="setShape('saturn')">–°–∞—Ç—É—Ä–Ω</button>
            <button onclick="setShape('dna')">–î–ù–ö</button>
        </div>
        <input type="color" id="colorPicker" value="#00ff88" style="width:100%">
    </div>

    <script>
        // --- –ó–ê–©–ò–¢–ê –û–¢ –ó–ê–í–ò–°–ê–ù–ò–Ø ---
        setTimeout(() => {
            const l = document.getElementById('loading');
            if(l && l.style.display !== 'none') l.style.display = 'none';
        }, 5000);

        // --- 1. SETUP THREE.JS ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 8;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. PARTICLES ---
        const COUNT = 18000;
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(COUNT * 3);
        for(let i=0; i<COUNT*3; i++) pos[i] = (Math.random()-0.5)*15;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        
        const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
        const ctx = cvs.getContext('2d');
        const grd = ctx.createRadialGradient(16,16,0,16,16,16);
        grd.addColorStop(0,'white'); grd.addColorStop(1,'transparent');
        ctx.fillStyle = grd; ctx.fillRect(0,0,32,32);
        const tex = new THREE.Texture(cvs); tex.needsUpdate = true;

        const mat = new THREE.PointsMaterial({
            size: 0.09, map: tex, transparent: true, 
            opacity: 0.8, blending: THREE.AdditiveBlending, 
            depthWrite: false, color: 0x00ff88
        });
        const particles = new THREE.Points(geo, mat);
        scene.add(particles);

        // --- 3. STATE ---
        let targetPositions = new Float32Array(COUNT*3);
        const state = { scale: 1, rx: 0, ry: 0, tilt: 0, beat: 0 };
        const target = { scale: 1, x: 0, y: 0, tilt: 0, detected: false };

        // --- 4. AUDIO SYSTEM (ROBUST FIX) ---
        let analyser, dataArray;
        let audioContext;
        let isAudioOn = false;

        async function startAudio() {
            if(isAudioOn) return;
            const btn = document.getElementById('mic-btn');

            try {
                // 1. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Safari/Chrome)
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();

                // 2. –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç "—Å–ø–∏—Ç", –±—É–¥–∏–º –µ–≥–æ
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // 4. –ü–æ–¥–∫–ª—é—á–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 128; // –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // 5. –£—Å–ø–µ—Ö
                isAudioOn = true;
                btn.innerText = "üîä –†–∞–±–æ—Ç–∞–µ—Ç";
                btn.classList.add('mic-active');

            } catch (err) {
                console.error(err);
                if (err.name === 'NotAllowedError') {
                    alert("–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω.\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∑–∞–º–∫–∞ üîí –≤ —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                } else if (err.name === 'NotFoundError') {
                    alert("–û—à–∏–±–∫–∞: –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                } else {
                    alert("–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ: " + err.message);
                }
            }
        }

        // --- 5. SHAPE LOGIC ---
        function setShape(s) {
            for(let i=0; i<COUNT; i++) {
                let x,y,z, r1=Math.random(), r2=Math.random();
                if(s==='sphere'){
                    const t=2*Math.PI*r1, p=Math.acos(2*r2-1), r=3.5;
                    x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p);
                } else if(s==='heart'){
                    const t=r1*6.28, p=r2*3.14;
                    x=16*Math.pow(Math.sin(t),3); 
                    y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
                    z=5*Math.cos(p)*Math.sin(t);
                    x*=0.18; y*=0.18; z*=0.18;
                } else if(s==='saturn') {
                    const ang=r1*6.28, dist=i<COUNT*0.6 ? 2.8 : 4+r2*3;
                    if(i<COUNT*0.6) {
                        const ph=Math.acos(2*r2-1);
                        x=dist*Math.sin(ph)*Math.cos(ang); y=dist*Math.sin(ph)*Math.sin(ang); z=dist*Math.cos(ph);
                    } else { x=Math.cos(ang)*dist; y=(r1-0.5)*0.2; z=Math.sin(ang)*dist; }
                } else { // DNA
                     const ang = (r1 * 3 * 6.28) + (i%2 * 3.14);
                     x=Math.cos(ang)*2 + (r2-0.5); y=(r1-0.5)*10; z=Math.sin(ang)*2 + (r2-0.5);
                }
                targetPositions[i*3]=x; targetPositions[i*3+1]=y; targetPositions[i*3+2]=z;
            }
            document.querySelectorAll('.shape-grid button').forEach(b=>b.classList.remove('active'));
            if(event) event.target.classList.add('active');
        }
        setShape('sphere');

        // --- 6. ANIMATION & LOGIC ---
        function lerp(s,e,a){return (1-a)*s+a*e;}

        let currentColor = new THREE.Color(0x00ff88);
        document.getElementById('colorPicker').addEventListener('input', (e)=>{
            currentColor.set(e.target.value);
        });

        function animate() {
            requestAnimationFrame(animate);
            
            // 1. Move Particles
            const p = particles.geometry.attributes.position.array;
            for(let i=0; i<COUNT*3; i++) p[i] += (targetPositions[i]-p[i])*0.05;
            particles.geometry.attributes.position.needsUpdate = true;

            // 2. Audio Analysis
            let beat = 0;
            if(isAudioOn && analyser) {
                analyser.getByteFrequencyData(dataArray);
                // Bass is usually first few bins
                let sum=0; for(let i=0; i<10; i++) sum+=dataArray[i];
                beat = (sum/10) / 255; // 0 to 1
                state.beat = lerp(state.beat, beat, 0.3); // Smooth beat
            }

            // 3. Color Beat Logic
            if(state.beat > 0.15) {
                const h = currentColor.getHSL({});
                // Make it brighter
                particles.material.color.setHSL(h.h, h.s, Math.min(1, h.l + state.beat*0.6));
            } else {
                particles.material.color.lerp(currentColor, 0.1);
            }

            // 4. Transform Logic
            if(target.detected) {
                state.scale = lerp(state.scale, target.scale, 0.1);
                state.rx = lerp(state.rx, target.y * 0.05, 0.1);
                state.ry = lerp(state.ry, target.x * 0.05, 0.1);
                state.tilt = lerp(state.tilt, -target.tilt, 0.1);
            } else {
                state.scale = lerp(state.scale, 1, 0.05);
                state.rx = lerp(state.rx, 0, 0.05);
                state.ry = lerp(state.ry, 0.002, 0.05);
                state.tilt = lerp(state.tilt, 0, 0.05);
            }

            // Combine Hand Scale + Audio Pulse
            const finalScale = state.scale + (state.beat * 0.5); 
            
            particles.scale.set(finalScale, finalScale, finalScale);
            particles.rotation.x += state.rx;
            particles.rotation.y += state.ry;
            particles.rotation.z = state.tilt;

            renderer.render(scene, camera);
        }
        animate();

        // --- 7. CAMERA SETUP ---
        const vid = document.getElementById('webcam-preview');
        
        function onResults(results) {
            document.getElementById('loading').style.display = 'none';
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                target.detected = true;
                const lm = results.multiHandLandmarks[0];
                const dist = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
                target.scale = Math.max(0.5, Math.min(2.8 - dist*9, 3));
                target.x = ((lm[0].x + lm[9].x)/2 - 0.5)*2;
                target.y = ((lm[0].y + lm[9].y)/2 - 0.5)*2;
                target.tilt = Math.atan2(lm[9].y-lm[0].y, lm[9].x-lm[0].x) + Math.PI/2;
            } else {
                target.detected = false;
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
        hands.onResults(onResults);

        const cameraUtils = new Camera(vid, {
            onFrame: async () => { await hands.send({image: vid}); },
            width: 320, height: 240
        });
        cameraUtils.start();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>