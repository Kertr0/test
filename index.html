<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Audio & Gestures Final</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary: #00ff88;
            --glass: rgba(15, 15, 15, 0.8);
            --border: rgba(255, 255, 255, 0.15);
        }
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Segoe UI', sans-serif; color: white; user-select: none;
        }

        /* --- –≠–ö–†–ê–ù –ó–ê–ü–£–°–ö–ê --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #222 0%, #000 100%);
            z-index: 999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        
        h1 { margin-bottom: 20px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; }
        
        #start-btn {
            padding: 18px 50px; font-size: 16px; background: var(--primary); color: #000;
            border: none; border-radius: 50px; cursor: pointer; font-weight: 800;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4); transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        #start-btn:hover { transform: scale(1.05); box-shadow: 0 0 50px rgba(0, 255, 136, 0.6); }

        /* --- –û–°–ù–û–í–ù–û–ô UI --- */
        #canvas-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; }
        
        .ui-panel {
            position: absolute; top: 20px; right: 20px; width: 250px;
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 16px; border: 1px solid var(--border);
            z-index: 10; display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ —Å—Ç–∞—Ä—Ç–∞ */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .shape-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        
        button.shape-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: #ccc; padding: 10px; border-radius: 8px; cursor: pointer;
            transition: all 0.2s; font-size: 12px; text-transform: uppercase;
        }
        button.shape-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
        button.shape-btn.active { 
            background: var(--primary); color: #000; font-weight: bold; 
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); border-color: var(--primary);
        }

        #status-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 8px 25px; border-radius: 30px;
            font-size: 13px; border: 1px solid var(--border);
            z-index: 10; display: none; color: #aaa;
        }
        #status-bar.active { color: var(--primary); border-color: var(--primary); }
        
        #webcam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 140px; height: 105px;
            background: #000; border: 1px solid var(--border); z-index: 10;
            border-radius: 10px; transform: scaleX(-1); opacity: 0.7; display: none;
        }
    </style>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- 1. –≠–ö–†–ê–ù –ó–ê–ü–£–°–ö–ê -->
    <div id="start-screen">
        <h1>Particle System AI</h1>
        <button id="start-btn" onclick="startSystem()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
            –í–∫–ª—é—á–∞–µ—Ç –ö–∞–º–µ—Ä—É (–ñ–µ—Å—Ç—ã) –∏ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–ü—É–ª—å—Å–∞—Ü–∏—è)
        </p>
    </div>

    <!-- 2. –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
    <div id="canvas-container"></div>
    <video id="webcam-preview" playsinline muted></video>
    <div id="status-bar">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ü–æ–∫–∞–∂–∏—Ç–µ —Ä—É–∫—É.</div>

    <div class="ui-panel" id="ui-panel">
        <h3 style="margin:0 0 15px 0; font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </h3>
        
        <div class="shape-grid">
            <button class="shape-btn active" onclick="setShape('sphere')">–°—Ñ–µ—Ä–∞</button>
            <button class="shape-btn" onclick="setShape('heart')">–°–µ—Ä–¥—Ü–µ</button>
            <button class="shape-btn" onclick="setShape('saturn')">–°–∞—Ç—É—Ä–Ω</button>
            <button class="shape-btn" onclick="setShape('dna')">–î–ù–ö</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:11px; color:#666; display:block; margin-bottom:5px;">–¶–í–ï–¢ –ß–ê–°–¢–ò–¶</label>
            <input type="color" id="colorPicker" value="#00ff88" style="width:100%; height:35px; border:none; background:none; cursor:pointer;">
        </div>
        
        <div style="font-size:11px; color:#888; line-height:1.6; background: rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
            ü§è <b>–ó—É–º:</b> –°–≤–µ—Å—Ç–∏ –ø–∞–ª—å—Ü—ã<br>
            üïπÔ∏è <b>–í—Ä–∞—â–µ–Ω–∏–µ:</b> –î–≤–∏–≥–∞—Ç—å —Ä—É–∫–æ–π<br>
            üîä <b>–ê—É–¥–∏–æ:</b> –ë–∞—Å –º–µ–Ω—è–µ—Ç –º–∞—Å—à—Ç–∞–±
        </div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let scene, camera, renderer, particles;
        let audioCtx, analyser, dataArray;
        let isAudioEnabled = false;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const CONFIG = {
            particleCount: 18000,
            baseSize: 0.08,
            smooth: 0.08
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        const STATE = {
            scale: 1,      // –¢–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–± (–æ—Ç —Ä—É–∫)
            audioPulse: 0, // –î–æ–±–∞–≤–æ—á–Ω—ã–π –º–∞—Å—à—Ç–∞–± (–æ—Ç –∑–≤—É–∫–∞)
            rotX: 0, rotY: 0, tilt: 0,
            baseColor: new THREE.Color(0x00ff88)
        };

        // –¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Ç MediaPipe)
        const TARGET = {
            scale: 1, x: 0, y: 0, tilt: 0, detected: false
        };

        // --- 1. –ó–ê–ü–£–°–ö (START) ---
        async function startSystem() {
            const btn = document.getElementById('start-btn');
            btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
            
            // A. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
            initThree();

            // B. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ê—É–¥–∏–æ (–¢—Ä–µ–±—É–µ—Ç –∂–µ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; // –î–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ –±–∞—Å–∞
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioEnabled = true;
            } catch(e) {
                console.warn("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:", e);
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –≤–∫–ª—é—á–µ–Ω. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –∂–µ—Å—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.");
            }

            // C. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe
            await initMediaPipe();

            // D. –°–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-panel').style.display = 'block';
            document.getElementById('webcam-preview').style.display = 'block';
            document.getElementById('status-bar').style.display = 'block';
        }

        // --- 2. THREE.JS (–†–µ–Ω–¥–µ—Ä) ---
        let targetPositions = new Float32Array(CONFIG.particleCount * 3);

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02); // –ì–ª—É–±–∏–Ω–∞

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 8;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // –¢–µ–∫—Å—Ç—É—Ä–∞ "–°–≤–µ—á–µ–Ω–∏–µ"
            const canvas = document.createElement('canvas'); canvas.width=32; canvas.height=32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0,16,16,16);
            grad.addColorStop(0,'rgba(255,255,255,1)');
            grad.addColorStop(0.4,'rgba(255,255,255,0.2)');
            grad.addColorStop(1,'transparent');
            ctx.fillStyle = grad; ctx.fillRect(0,0,32,32);
            const tex = new THREE.Texture(canvas); tex.needsUpdate = true;

            // –ß–∞—Å—Ç–∏—Ü—ã
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.particleCount * 3);
            for(let i=0; i<CONFIG.particleCount*3; i++) pos[i] = (Math.random()-0.5)*20;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));

            const mat = new THREE.PointsMaterial({
                size: CONFIG.baseSize, map: tex, transparent: true, opacity: 0.8,
                blending: THREE.AdditiveBlending, depthWrite: false, color: STATE.baseColor
            });

            particles = new THREE.Points(geo, mat);
            scene.add(particles);

            setShape('sphere');
            animate();
        }

        // --- 3. –ê–ù–ò–ú–ê–¶–ò–Ø –ò –õ–û–ì–ò–ö–ê ---
        function lerp(start, end, amt) { return (1-amt)*start + amt*end; }

        function animate() {
            requestAnimationFrame(animate);

            // --- A. –ê–ù–ê–õ–ò–ó –ó–í–£–ö–ê ---
            if (isAudioEnabled && analyser) {
                analyser.getByteFrequencyData(dataArray);
                
                // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∏–∑–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (–ë–∞—Å)
                // dataArray –∏–º–µ–µ—Ç 128 —è—á–µ–µ–∫. –ë–∞—Å—ã - —ç—Ç–æ –ø–µ—Ä–≤—ã–µ 10-15.
                let bassSum = 0;
                for(let i = 0; i < 10; i++) bassSum += dataArray[i];
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º (0.0 ... 1.0)
                const bassLevel = (bassSum / 10) / 255;
                
                // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–∏
                STATE.audioPulse = lerp(STATE.audioPulse, bassLevel, 0.2);

                // –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏ —Ü–≤–µ—Ç–∞ –Ω–∞ —Å–∏–ª—å–Ω—ã—Ö —É–¥–∞—Ä–∞—Ö
                if (STATE.audioPulse > 0.4) { // –ü–æ—Ä–æ–≥ —É–¥–∞—Ä–∞
                    const h = STATE.baseColor.getHSL({});
                    // –î–µ–ª–∞–µ–º —Ü–≤–µ—Ç –ø–æ—á—Ç–∏ –±–µ–ª—ã–º –ø—Ä–∏ —É–¥–∞—Ä–µ
                    particles.material.color.setHSL(h.h, h.s, Math.min(1.0, 0.5 + STATE.audioPulse));
                } else {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –±–∞–∑–æ–≤–æ–º—É —Ü–≤–µ—Ç—É
                    particles.material.color.lerp(STATE.baseColor, 0.1);
                }
            }

            // --- B. –û–ë–†–ê–ë–û–¢–ö–ê –ñ–ï–°–¢–û–í (MediaPipe) ---
            if (TARGET.detected) {
                // –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª—è–º –æ—Ç —Ä—É–∫–∏
                STATE.scale = lerp(STATE.scale, TARGET.scale, CONFIG.smooth);
                
                // –í—Ä–∞—â–µ–Ω–∏–µ (–î–∂–æ–π—Å—Ç–∏–∫)
                // –ï—Å–ª–∏ —Ä—É–∫–∞ —Å–º–µ—â–µ–Ω–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 0.1, –∫—Ä—É—Ç–∏–º
                const vx = (Math.abs(TARGET.x) > 0.1) ? TARGET.x * 0.05 : 0;
                const vy = (Math.abs(TARGET.y) > 0.1) ? TARGET.y * 0.05 : 0;
                STATE.rotY = lerp(STATE.rotY, vx, CONFIG.smooth);
                STATE.rotX = lerp(STATE.rotX, vy, CONFIG.smooth);
                
                STATE.tilt = lerp(STATE.tilt, -TARGET.tilt, CONFIG.smooth);
            } else {
                // –†–µ–∂–∏–º –ø—Ä–æ—Å—Ç–æ—è
                STATE.scale = lerp(STATE.scale, 1.0, 0.05);
                STATE.rotY = lerp(STATE.rotY, 0.002, 0.05); // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
                STATE.rotX = lerp(STATE.rotX, 0, 0.05);
                STATE.tilt = lerp(STATE.tilt, 0, 0.05);
            }

            // --- C. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ô ---
            
            // –ò—Ç–æ–≥–æ–≤—ã–π –º–∞—Å—à—Ç–∞–± = –ú–∞—Å—à—Ç–∞–± –æ—Ç —Ä—É–∫–∏ + –ü—É–ª—å—Å–∞—Ü–∏—è –∑–≤—É–∫–∞
            // –£–º–Ω–æ–∂–∞–µ–º audioPulse –Ω–∞ 0.5, —á—Ç–æ–±—ã –ø—É–ª—å—Å–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º –æ–≥—Ä–æ–º–Ω–æ–π
            const totalScale = STATE.scale + (STATE.audioPulse * 0.5);
            
            particles.scale.set(totalScale, totalScale, totalScale);
            particles.rotation.y += STATE.rotY;
            particles.rotation.x += STATE.rotX;
            particles.rotation.z = STATE.tilt;

            // –ú–æ—Ä—Ñ–∏–Ω–≥ (–¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫ —Ñ–æ—Ä–º–µ)
            const p = particles.geometry.attributes.position.array;
            for(let i=0; i<CONFIG.particleCount*3; i++) {
                p[i] += (targetPositions[i] - p[i]) * 0.08;
            }
            particles.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }

        // --- 4. MEDIAPIPE (–†—É–∫–∏) ---
        async function initMediaPipe() {
            const videoElement = document.getElementById('webcam-preview');
            const statusBar = document.getElementById('status-bar');

            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    TARGET.detected = true;
                    statusBar.classList.add('active');
                    statusBar.innerText = "–†–£–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê";

                    const lm = results.multiHandLandmarks[0];

                    // 1. Zoom (–©–∏–ø–æ–∫)
                    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–æ–ª—å—à–∏–º(4) –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–º(8)
                    const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    // –ò–Ω–≤–µ—Ä—Å–∏—è: –ë–ª–∏–∑–∫–æ(0.02) -> Scale 3.0. –î–∞–ª–µ–∫–æ(0.2) -> Scale 0.5
                    TARGET.scale = Math.max(0.5, Math.min(3.0 - (dist * 10), 3.0));

                    // 2. –î–∂–æ–π—Å—Ç–∏–∫ (–ü–æ–ª–æ–∂–µ–Ω–∏–µ)
                    // lm[9] - –∫–æ—Å—Ç—è—à–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–∞–ª—å—Ü–∞ (—Ü–µ–Ω—Ç—Ä –ª–∞–¥–æ–Ω–∏)
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: 0..1 -> -1..1
                    TARGET.x = ((lm[9].x) - 0.5) * 2;
                    TARGET.y = ((lm[9].y) - 0.5) * 2;

                    // 3. –ù–∞–∫–ª–æ–Ω
                    // –£–≥–æ–ª –º–µ–∂–¥—É –∑–∞–ø—è—Å—Ç—å–µ–º(0) –∏ —Å—Ä–µ–¥–Ω–∏–º(9)
                    const dx = lm[9].x - lm[0].x;
                    const dy = lm[9].y - lm[0].y;
                    TARGET.tilt = Math.atan2(dy, dx) + Math.PI/2;

                } else {
                    TARGET.detected = false;
                    statusBar.classList.remove('active');
                    statusBar.innerText = "–ü–û–ö–ê–ñ–ò–¢–ï –†–£–ö–£";
                }
            });

            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 320, height: 240
            });

            return camera.start();
        }

        // --- 5. –§–û–†–ú–´ –ò –£–¢–ò–õ–ò–¢–´ ---
        window.setShape = function(s) {
            for(let i=0; i<CONFIG.particleCount; i++) {
                let x,y,z, r1=Math.random(), r2=Math.random();
                
                if(s==='sphere'){
                    const t=r1*6.28, p=Math.acos(2*r2-1), r=3.5;
                    x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p);
                } else if(s==='heart'){
                    const t=r1*6.28, p=r2*3.14;
                    x=16*Math.pow(Math.sin(t),3); 
                    y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
                    z=5*Math.cos(p)*Math.sin(t);
                    x*=0.18; y*=0.18; z*=0.18;
                } else if(s==='saturn') {
                    const ang=r1*6.28, dist=i<CONFIG.particleCount*0.7 ? 2.8 : 4+r2*3;
                    if(i<CONFIG.particleCount*0.7) {
                        const ph=Math.acos(2*r2-1);
                        x=dist*Math.sin(ph)*Math.cos(ang); y=dist*Math.sin(ph)*Math.sin(ang); z=dist*Math.cos(ph);
                    } else { x=Math.cos(ang)*dist; y=(r1-0.5)*0.3; z=Math.sin(ang)*dist; }
                } else { // DNA
                     const ang = (r1 * 3 * 6.28) + (i%2 * 3.14);
                     x=Math.cos(ang)*2 + (r2-0.5); y=(r1-0.5)*10; z=Math.sin(ang)*2 + (r2-0.5);
                }
                targetPositions[i*3]=x; targetPositions[i*3+1]=y; targetPositions[i*3+2]=z;
            }
            // UI Update
            document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
        };

        document.getElementById('colorPicker').addEventListener('input', (e) => {
            STATE.baseColor.set(e.target.value);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>